---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../components/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents';
import ReadingProgress from '../../components/ReadingProgress';
import '../../../src/styles/prose.css';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'posts'>;
}

const { post } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await post.render();

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <ReadingProgress client:load />
  
  <article class="container">
    <div class="post-layout">
      <div class="post-main">
        <header class="post-header">
          <h1 class="post-title">{post.data.title}</h1>
          
          <div class="post-metadata">
            <time datetime={post.data.date.toISOString()} class="text-secondary">
              {formatDate(post.data.date)}
            </time>
            
            {remarkPluginFrontmatter?.minutesRead && (
              <>
                <span class="text-secondary">•</span>
                <span class="text-secondary">{remarkPluginFrontmatter.minutesRead}</span>
              </>
            )}
            
            {post.data.updated && (
              <>
                <span class="text-secondary">•</span>
                <span class="text-secondary" title={`Updated ${formatDate(post.data.updated)}`}>
                  Updated {formatDate(post.data.updated)}
                </span>
              </>
            )}
          </div>
          
          {post.data.tags.length > 0 && (
            <div class="post-tags">
              {post.data.tags.map((tag) => (
                <a href={`/tags/${tag}`} class="tag">{tag}</a>
              ))}
            </div>
          )}
        </header>
        
        {post.data.heroImage && (
          <img 
            src={post.data.heroImage} 
            alt={post.data.title} 
            class="hero-image"
          />
        )}
        
        <div class="prose">
          <Content />
        </div>
      </div>
      
      {headings.length > 0 && (
        <aside class="post-sidebar">
          <TableOfContents headings={headings} client:load />
        </aside>
      )}
    </div>
  </article>
</BaseLayout>

<style>
  .reading-progress-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background-color: var(--color-bg-secondary);
    z-index: 1000;
  }

  .reading-progress-bar {
    height: 100%;
    background-color: var(--color-accent);
    transition: width 150ms ease;
  }

  .post-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-2xl);
    position: relative;
  }

  @media (min-width: 1024px) {
    .post-layout {
      grid-template-columns: 1fr 250px;
    }
  }

  .post-main {
    min-width: 0;
  }

  .post-header {
    margin-bottom: var(--space-2xl);
  }

  .post-title {
    margin-top: 0;
    margin-bottom: var(--space-md);
    font-size: var(--font-size-4xl);
  }

  .post-metadata {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: wrap;
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-md);
  }

  .post-tags {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }

  .tag {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    transition: border-color var(--transition-fast), color var(--transition-fast);
  }

  .tag:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    text-decoration: none;
  }

  .hero-image {
    width: 100%;
    height: auto;
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-2xl);
  }

  .post-sidebar {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: var(--space-sm);
  }

  @media (min-width: 1024px) {
    .post-sidebar {
      position: sticky;
      top: 2rem;
      align-self: start;
      max-height: calc(100vh - 4rem);
      overflow: visible;
    }
  }

  /* TOC Styles */
  :global(.toc-shell) {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: var(--space-sm);
    width: 100%;
  }

  :global(.toc) {
    position: relative;
    padding: var(--space-md) var(--space-lg);
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    width: 100%;
    transition: opacity var(--transition-fast), transform var(--transition-fast), max-height var(--transition-fast),
      padding var(--transition-fast), border-color var(--transition-fast), background-color var(--transition-fast);
  }

  :global(.toc-shell.toc-closed .toc) {
    opacity: 0;
    transform: translateX(10px);
    max-height: 0;
    padding: 0;
    border-width: 0;
    margin: 0;
    pointer-events: none;
  }

  :global(.toc-header) {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  :global(.toc-title) {
    margin: 0;
    font-size: var(--font-size-base);
    font-weight: 600;
  }

  :global(.toc-panel) {
    overflow: hidden;
    transition: opacity var(--transition-fast), transform var(--transition-fast), max-height var(--transition-fast);
    opacity: 1;
    transform: translateX(0);
    max-height: 600px;
  }

  :global(.toc-panel.is-closed) {
    opacity: 0;
    transform: translateX(10px);
    max-height: 0;
    pointer-events: none;
  }

  :global(.toc-shell.toc-out-of-view .toc) {
    z-index: 3;
  }

  :global(.toc-visibility-sentinel) {
    width: 1px;
    height: 1px;
    pointer-events: none;
  }

  :global(.toc-list) {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  :global(.toc-item) {
    margin: 0;
    padding: 0;
  }

  :global(.toc-item a) {
    display: block;
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    border-left: 2px solid transparent;
    transition: all var(--transition-fast);
    text-decoration: none;
  }

  :global(.toc-item a:hover) {
    color: var(--color-text);
    background-color: var(--color-bg);
  }

  :global(.toc-item.active a) {
    color: var(--color-accent);
    border-left-color: var(--color-accent);
    background-color: var(--color-bg);
  }

  :global(.toc-depth-3) {
    padding-left: var(--space-md);
  }

  :global(.toc-toggle) {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background-color: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background-color var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast),
      transform var(--transition-fast);
  }

  :global(.toc-toggle:hover),
  :global(.toc-toggle:focus-visible) {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background-color: var(--color-bg-secondary);
    outline: none;
  }

  :global(.toc-toggle:focus-visible) {
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-accent) 25%, transparent);
  }

  :global(.toc-toggle-icon) {
    display: inline-flex;
    transition: transform var(--transition-fast);
  }

  :global(.toc-toggle-icon.is-open) {
    transform: rotate(90deg);
  }

  :global(.toc-toggle-floating) {
    position: sticky;
    bottom: 0;
    right: 0;
    align-self: flex-end;
    z-index: 2;
  }
  @media (max-width: 1023px) {
    .post-sidebar {
      order: -1;
    }

    :global(.toc-shell) {
      width: auto;
      align-items: stretch;
    }

    :global(.toc) {
      flex-direction: column;
    }

    :global(.toc-panel) {
      width: 100%;
    }

    :global(.toc-toggle-floating) {
      position: fixed;
      bottom: var(--space-md);
      left: 50%;
      right: auto;
      transform: translateX(-50%);
    }

    :global(.toc-shell.toc-out-of-view .toc-toggle-floating) {
      bottom: var(--space-lg);
    }

    :global(.toc-shell.toc-out-of-view .toc) {
      position: fixed;
      left: 50%;
      bottom: calc(var(--space-xl) * 2);
      transform: translateX(-50%);
      width: min(92vw, 420px);
      max-height: 50vh;
      overflow: auto;
      box-shadow: 0 10px 40px color-mix(in srgb, var(--color-bg) 25%, transparent);
    }
  }
</style>
